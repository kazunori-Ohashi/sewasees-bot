# 📚 TDD Discord Bot - API リファレンス

このドキュメントでは、TDD Discord Botのすべての機能と使用方法を詳細に説明します。

## 📋 目次

1. [概要](#概要)
2. [スラッシュコマンド](#スラッシュコマンド)
3. [リアクション機能](#リアクション機能)
4. [サポートファイル形式](#サポートファイル形式)
5. [レート制限](#レート制限)
6. [エラーハンドリング](#エラーハンドリング)
7. [設定オプション](#設定オプション)
8. [使用例](#使用例)

---

## 概要

TDD Discord Botは、ファイル・音声・動画を処理してMarkdown記事やTLDR要約を生成するBotです。OpenAI GPT-4o-miniとWhisper APIを使用し、高品質な文書生成を提供します。

### 🎯 主要機能

- **📄 記事生成**: PREP/PAS形式のMarkdown記事作成
- **📋 TLDR生成**: 長文コンテンツの要約
- **🎤 音声認識**: Whisper APIによる文字起こし
- **📱 PDF処理**: pdfminer.sixによるテキスト抽出
- **⚡ 非同期処理**: 高速ファイル処理
- **🔒 セキュリティ**: 悪意あるファイルの自動拒否

---

## スラッシュコマンド

### 1. `/article` - 記事生成

**説明**: ファイルから構造化されたMarkdown記事を生成します。

**構文**:
```
/article file:<file> [style:<style>] [include_tldr:<bool>]
```

**パラメータ**:
| パラメータ | 型 | 必須 | 説明 | デフォルト |
|------------|----|----|------|-----------|
| `file` | Attachment | ✅ | 処理したいファイル | - |
| `style` | String | ❌ | 記事スタイル (`prep` または `pas`) | `prep` |
| `include_tldr` | Boolean | ❌ | TLDR要約も含めるか | `false` |

**記事スタイル**:
- **`prep`**: Point → Reason → Example → Point の構造
- **`pas`**: Problem → Agitation → Solution の構造

**出力**:
- Markdown形式のファイル (`.md`)
- 記事生成完了のEmbed通知

**例**:
```
/article file:meeting_notes.txt style:prep include_tldr:true
```

---

### 2. `/tldr` - 要約生成

**説明**: ファイルからTLDR（要約）を生成します。

**構文**:
```
/tldr file:<file>
```

**パラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|------------|----|----|------|
| `file` | Attachment | ✅ | 要約したいファイル |

**出力**:
- 3〜5つの要点を絵文字付き箇条書きで表示
- ファイル情報を含むEmbed

**例**:
```
/tldr file:long_document.pdf
```

**出力例**:
```
📝 TLDR (要約)
🔹 この文書では新製品の市場戦略について説明している
🔹 ターゲット顧客は20-40代のテクノロジー愛好者
🔹 マーケティング予算は年間500万円で設定
```

---

### 3. `/usage` - 使用状況確認

**説明**: 本日の使用回数を確認します。

**構文**:
```
/usage
```

**パラメータ**: なし

**出力**:
- 無料ユーザー: 残り使用回数/日次制限
- Premiumユーザー: 無制限利用可能の表示

**例**:
```
/usage
→ "本日の残り使用回数: 3/5回"
```

---

## リアクション機能

### 🎤 音声・動画文字起こし

**説明**: 音声または動画ファイルにリアクションして文字起こしを実行します。

**使用方法**:
1. 音声・動画ファイルが添付されたメッセージを見つける
2. そのメッセージに 🎤 リアクションを追加
3. Botが自動的にWhisper APIで文字起こしを実行
4. 結果をテキストファイルとして送信

**サポート形式**:
- **音声**: `.mp3`, `.wav`, `.m4a`, `.ogg`
- **動画**: `.mp4`, `.webm`

**出力**:
- 文字起こし結果の `.txt` ファイル
- 文字起こし完了のEmbed通知

---

## サポートファイル形式

### 📄 テキストファイル

| 拡張子 | 処理方法 | 文字エンコーディング |
|--------|----------|---------------------|
| `.txt` | 直接読み込み | UTF-8, CP932, Shift_JIS, ISO-2022-JP |
| `.md` | 直接読み込み | UTF-8, CP932, Shift_JIS, ISO-2022-JP |

### 📱 PDFファイル

| 拡張子 | 処理方法 | 制限事項 |
|--------|----------|----------|
| `.pdf` | pdfminer.six | テキスト埋め込みPDFのみ、画像PDFは未対応 |

**注意**: 
- スキャン画像のPDFは処理できません
- パスワード保護されたPDFは未対応
- 最大8000文字まで（超過分は切り詰め）

### 🎵 音声ファイル

| 拡張子 | 処理方法 | 最大サイズ |
|--------|----------|------------|
| `.mp3` | Whisper API | 10MB |
| `.wav` | Whisper API | 10MB |
| `.m4a` | Whisper API | 10MB |
| `.ogg` | Whisper API | 10MB |

### 🎬 動画ファイル

| 拡張子 | 処理方法 | 最大サイズ |
|--------|----------|------------|
| `.mp4` | FFmpeg + Whisper API | 10MB |
| `.webm` | FFmpeg + Whisper API | 10MB |

**処理フロー**:
1. FFmpegで音声抽出 (16kHz, モノラル)
2. Whisper APIで文字起こし
3. テキスト化

---

## レート制限

### 制限ルール

| ユーザータイプ | 日次制限 | リセット時間 | 備考 |
|---------------|----------|--------------|------|
| 無料ユーザー | 5回/日 | 毎日 00:00 UTC | `/article`と`/tldr`の合計 |
| Premiumユーザー | 無制限 | - | 環境変数で設定されたロール名で判定 |

### 制限対象

**制限される操作**:
- ✅ `/article` コマンド
- ✅ `/tldr` コマンド  
- ✅ 🎤 リアクション処理

**制限されない操作**:
- ❌ `/usage` コマンド
- ❌ ヘルプやエラーメッセージ

### カスタマイズ

環境変数で制限値を変更可能:
```bash
DAILY_RATE_LIMIT=10        # 無料ユーザーの日次制限を10回に変更
PREMIUM_ROLE_NAME=vip      # Premiumロール名を"vip"に変更
```

---

## エラーハンドリング

### 一般的なエラー

| エラータイプ | 原因 | 解決方法 |
|-------------|------|----------|
| **使用回数制限** | 日次制限超過 | 翌日まで待機またはPremium取得 |
| **ファイルサイズエラー** | 10MB超過 | ファイルサイズを縮小 |
| **サポート外形式** | 未対応拡張子 | サポート形式に変換 |
| **処理エラー** | ファイル破損等 | ファイルを再確認 |

### OpenAI API エラー

| エラータイプ | 原因 | 対処法 |
|-------------|------|--------|
| **API制限** | レート制限到達 | 少し時間を置いて再試行 |
| **クレジット不足** | OpenAIアカウントの残高不足 | アカウントにクレジット追加 |
| **長すぎるコンテンツ** | トークン制限超過 | ファイルサイズを縮小 |

### システムエラー

| エラータイプ | 原因 | 対処法 |
|-------------|------|--------|
| **Redis接続エラー** | Redisサーバー停止 | `redis-server`で起動 |
| **FFmpeg エラー** | FFmpeg未インストール | FFmpegをシステムにインストール |
| **依存関係エラー** | Pythonパッケージ不足 | `pip install -r requirements.txt` |

---

## 設定オプション

### 環境変数設定

#### 必須設定

```bash
# Discord Bot Token
DISCORD_TOKEN=your_discord_bot_token_here

# OpenAI API Key  
OPENAI_API_KEY=your_openai_api_key_here
```

#### オプション設定

```bash
# Redis設定
REDIS_HOST=localhost                    # Redisサーバーホスト
REDIS_PORT=6379                        # Redisサーバーポート
REDIS_DB=0                             # Redis データベース番号
REDIS_PASSWORD=password                # Redis パスワード（必要時）

# Bot動作設定
DAILY_RATE_LIMIT=5                     # 無料ユーザー日次制限
PREMIUM_ROLE_NAME=premium              # Premiumロール名（小文字）

# 管理機能
MODERATOR_CHANNEL_ID=123456789012345678 # モデレーターログチャンネルID

# デバッグ
DEBUG=false                            # デバッグログ有効/無効
```

### ロール設定

**Premiumロール設定手順**:
1. Discordサーバーでロールを作成（例: `@Premium`）
2. 環境変数 `PREMIUM_ROLE_NAME=premium` を設定
3. ユーザーにロールを付与
4. 該当ユーザーは使用回数制限が解除される

---

## 使用例

### 📋 基本的な使用例

#### 1. 会議録の記事化

```
1. 会議の音声録音ファイル (meeting.mp3) を用意
2. Discord上で以下を実行:
   /article file:meeting.mp3 style:prep include_tldr:true
3. 出力:
   - TLDR付きMarkdown記事ファイル
   - 構造化された会議の要点整理
```

#### 2. PDFドキュメントの要約

```
1. PDFファイル (report.pdf) を用意
2. Discord上で以下を実行:
   /tldr file:report.pdf
3. 出力:
   - 3-5つの要点をEmbed形式で表示
   - 素早い内容把握が可能
```

#### 3. リアクションによる文字起こし

```
1. 音声ファイルが添付されたメッセージを見つける
2. そのメッセージに 🎤 リアクションを追加
3. 出力:
   - 文字起こしテキストファイル
   - レート制限にカウント
```

### 🚀 高度な使用例

#### 1. 動画セミナーのコンテンツ化

```
シナリオ: 60分のセミナー動画から記事とTLDRを作成

手順:
1. 動画ファイルを10MB以下に分割
2. /tldr file:seminar_part1.mp4  # 各部分の要点確認
3. /article file:seminar_part1.mp4 style:prep include_tldr:true
4. 複数ファイルの結果をまとめて最終記事を作成
```

#### 2. 多言語文書の処理

```
シナリオ: 英語PDFの日本語要約作成

手順:
1. 英語PDF文書を用意
2. /tldr file:english_doc.pdf
3. Botが自動的に日本語で要約を生成
4. 必要に応じて /article で詳細記事も作成
```

#### 3. チーム運用での活用

```
シナリオ: 開発チームでの情報共有自動化

設定:
1. #meeting-notes チャンネルを作成
2. MODERATOR_CHANNEL_ID に設定
3. 議事録音声ファイルを🎤リアクションで処理
4. 管理者は全ての処理ログを監視可能
```

---

## 📊 パフォーマンス指標

### 処理時間

| ファイル形式 | サイズ | 平均処理時間 | 備考 |
|-------------|--------|-------------|------|
| テキスト | 1KB-1MB | 1-3秒 | ほぼ即座 |
| PDF | 1MB-5MB | 2-5秒 | テキスト抽出時間含む |
| 音声 | 1分-10分 | 10-60秒 | Whisper API依存 |
| 動画 | 1分-10分 | 15-90秒 | 音声抽出+認識時間 |

### コスト見積もり

| 処理タイプ | OpenAI料金 | 1回あたりコスト目安 |
|-----------|-----------|-------------------|
| TLDR生成 | $0.15/Mトークン (入力) | $0.001-0.003 |
| 記事生成 | $0.60/Mトークン (出力) | $0.005-0.015 |
| 音声認識 | $0.006/分 | $0.006-0.060 |

**月間利用コスト例** (無料ユーザー150回/月):
- TLDR中心: 約$0.45/月
- 記事生成中心: 約$2.25/月
- 音声処理中心: 約$0.90/月

---

## 🔗 関連ドキュメント

- **[セットアップガイド](SETUP_GUIDE.md)** - インストールと初期設定
- **[デプロイメントガイド](DEPLOYMENT_GUIDE.md)** - 本番環境への展開
- **[メインREADME](TDD_BOT_README.md)** - プロジェクト概要

---

**API Reference v2.0 - TDD Discord Bot** 🤖📚